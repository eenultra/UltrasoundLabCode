HEX
( FORGET AX
( A400 DP !
USER AX
USER STP
USER PORT

: BLUETOOTH 1 BT ! 1 PORT ! 2 TMODE ! ;
: TEACHPAD 0 BT ! 0 PORT ! 1 TMODE ! ;
: INIT1
68 1F JUMP
;

: MODE MODE
TOOLMODE C@ IF ." TOOL " ELSE ." WORLD " THEN
;
DECIMAL

: GOFORIT
TRANSFORM
QUITFLAG C@ 0= IF -GOTO ELSE DROP THEN
;
: YTOOL
(PLUNGE)
GOFORIT
;
: XTOOL
CARTMODE C@ 0= ( IF NOT ALREADY IN CARTESIAN MODE )
FCART C@ 0= ( CART MODE BUT NOT VALID )
OR IF COMPUTE THEN
SAVEAXES
TRIANGULATE ( TO FIND EXISTING VALUE OF LEN )
  ( ARG ) DUP 0 W @ 10 * - COS M* 10000 M/ X +! ( CHANGE IN X
  ( ARG )     0 W @ 10 * - SIN M* 10000 M/ Y +! ( CHANGE IN Y
GOFORIT
;
HEX
: MOVIT
QUITFLAG C0SET
AX !
BANK C0SET
    PAD 1+ C@ DUP 50 = IF INCR @ AX @ +! THEN
           4D = IF 0 INCR @ - AX @ +! THEN
TRANSFORM
QUITFLAG C@ 0= IF -GOTO ELSE DROP THEN
IOFLAG C0SET
;
: WH
BT @ 0= IF CR THEN
QUITFLAG C@ 0= IF
 PORT @ IOFLAG ! ( 0D EMIT ) 43 EMIT X ? Y ? Z ? 0 . W ? 0 . 0D EMIT
THEN
 IOFLAG C0SET
BT @ 0= IF CR THEN
;
( : WH ;
: LRN
  LEARN
  IOFLAG C0SET
  24 EMIT
    SPACE ." OK" CR
  KEY DROP ( ESC
;
: UNLRN
  LEARN
  IOFLAG C0SET
  25 EMIT
    SPACE ." OK" CR
  KEY DROP ( ESC
;

: HEA
  PAD C@ DUP 47 = IF ( G
     PAD 1+ C@ DUP 50 = IF GRIP THEN
                   4D = IF UNGRIP THEN
  THEN

  DUP 48 = IF ( H
WH
  THEN

  DUP 45 = IF ( E
HOME
  THEN

      41 = IF ( A
          FALIGN @ IF NONALIGN ELSE ALIGN THEN
  THEN
;
: XYZ
  DUP 58 = IF
    TOOLMODE @ IF
      PAD 1+ C@ 4D = IF 0 INCR @ - INCR ! THEN
      INCR @ XTOOL
    ELSE 
     X MOVIT
    THEN
  THEN

  DUP 59 = IF
    TOOLMODE @ IF
      PAD 1+ C@ 4D = IF 0 INCR @ - INCR ! THEN
      INCR @ YTOOL
    ELSE 
      Y MOVIT
    THEN
  THEN

      5A = IF
      Z MOVIT
  THEN
;
: XYZTOOL
    54 = IF  ( T
0D EMIT 4D EMIT
      TOOLMODE @ 0 = IF
         FALIGN C@ IF
           TOOL
           ." TOOL MODE" 0D EMIT
         ELSE
           ." USE ALIGN FIRST" 0D EMIT
         THEN
      ELSE
         WORLD
         ." WORLD MODE" 0D EMIT
      THEN
      PORT @ 0= IF CR THEN
   THEN
;
: TEXPECT
0 PAD PAD 10 + FILL
10 0 DO
   KEY DUP PAD I + C!
   0D = IF LEAVE THEN
LOOP
;
: NEXUS
BT @ IF ." BLUETOOTH " THEN
INIT1
2 TMODE !
0 STP !
0 TOOLMODE !
SAVEAXES
BEGIN
  PORT @ IOFLAG !
0D EMIT
  ( PAD 40 ) TEXPECT
  PAD C@ DUP 53 = IF 1 STP ! THEN ( S
      PAD 2+ NUMBER DUP 0 > IF INCR ! ELSE DROP THEN

  DUP XYZTOOL

  DUP XYZ

  DUP 46 = IF  ( F
    FN @ IF FN @ EXECUTE THEN
  THEN

(  DUP 50 = IF ( P
(    PITCH MOVIT
(  THEN

  DUP 57 = IF ( W
    W MOVIT
  THEN

(  DUP 52 = IF ( R
(    ROLL MOVIT
(  THEN

  HEA
  WH
  DUP 4C = IF ( L
LRN
  THEN
      55 = IF ( U
UNLRN
  THEN

STP @ ?TERMINAL OR UNTIL
0 TMODE !
;
: JOG
BT @ IF NEXUS ELSE JOG ( OLD ) THEN
;
: NEXPAD
BLUETOOTH
NEXUS
;
: COMLIST
CR ." XPval XMval YPval YMval ZPval ZMval PPval PMval WPval WMval RPval RMval"
CR ." GP GM H (WH) E (READY) A (ALIGN) T (TOOL) F (FN) L U S" CR
;
: RCOM
INIT1
CR
BEGIN
  IOFLAG C1SET
  TEXPECT
  IOFLAG C0SET
  PAD 6 TYPE CR
?TERMINAL UNTIL
;
: TCOM
INIT1
BEGIN
  PAD 10 EXPECT
  IOFLAG C1SET 4D EMIT PAD 10 TYPE 0D EMIT IOFLAG C0SET
?TERMINAL UNTIL
;

 0B ' PSAVE 2+ ! ( CHANGE PSAVE FROM 4-A TO 4-B
 B000 DP !
 HERE 9FFA ! CONTEXT @ 9FFC ! UVP @ 9FFE !
DECIMAL